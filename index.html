<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PinoyCart - Your Filipino Marketplace</title>
  <style>
    /* CSS Variables */
    :root {
      --red: #E63946;
      --blue: #1D4ED8;
      --gold: #C8A951;
      --white: #FFFFFF;
      --bg-light: #F9FAFB;
      --text-dark: #1F2937;
      --text-gray: #6B7280;
      --border: #E5E7EB;
      --shadow: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 25px rgba(0,0,0,0.15);
    }

    [data-theme="dark"] {
      --white: #1F2937;
      --bg-light: #111827;
      --text-dark: #F9FAFB;
      --text-gray: #D1D5DB;
      --border: #374151;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-light);
      color: var(--text-dark);
      line-height: 1.6;
      padding-bottom: 70px;
    }

    /* Header */
    header {
      background: var(--white);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--red);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
    }

    .search-bar {
      flex: 1;
      max-width: 500px;
      position: relative;
    }

    .search-bar input {
      width: 100%;
      padding: 0.5rem 2.5rem 0.5rem 1rem;
      border: 1px solid var(--border);
      border-radius: 24px;
      font-size: 0.9rem;
    }

    .search-bar button {
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--text-gray);
      cursor: pointer;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .icon-btn {
      background: none;
      border: none;
      color: var(--text-dark);
      cursor: pointer;
      position: relative;
      padding: 0.5rem;
      transition: color 0.2s;
    }

    .icon-btn:hover {
      color: var(--red);
    }

    .badge {
      position: absolute;
      top: 0;
      right: 0;
      background: var(--red);
      color: var(--white);
      border-radius: 12px;
      padding: 0.1rem 0.4rem;
      font-size: 0.7rem;
      font-weight: 600;
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--white);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      padding: 0.5rem 0;
      z-index: 100;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.2rem;
      color: var(--text-gray);
      font-size: 0.75rem;
      cursor: pointer;
      padding: 0.5rem 1rem;
      transition: color 0.2s;
      background: none;
      border: none;
    }

    .nav-item.active, .nav-item:hover {
      color: var(--red);
    }

    /* Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }

    /* Section */
    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /* Button Styles */
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: center;
    }

    .btn-primary {
      background: var(--red);
      color: var(--white);
    }

    .btn-primary:hover {
      background: #c32f3b;
    }

    .btn-secondary {
      background: var(--blue);
      color: var(--white);
    }

    .btn-secondary:hover {
      background: #1e40af;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-dark);
    }

    .btn-outline:hover {
      background: var(--bg-light);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Input Styles */
    .input-group {
      margin-bottom: 1rem;
    }

    .input-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      font-size: 0.9rem;
    }

    .input-group input,
    .input-group textarea,
    .input-group select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.95rem;
      font-family: inherit;
    }

    .input-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* Card Styles */
    .card {
      background: var(--white);
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      margin-bottom: 1rem;
    }

    .card-header {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    /* Product Grid */
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .product-card {
      background: var(--white);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .product-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .product-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: var(--bg-light);
    }

    .product-info {
      padding: 1rem;
    }

    .product-name {
      font-weight: 600;
      margin-bottom: 0.5rem;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .product-price {
      font-size: 1.25rem;
      color: var(--red);
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .product-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text-dark);
      color: var(--white);
      padding: 1rem 1.5rem;
      border-radius: 6px;
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
      max-width: 90%;
    }

    .toast.show {
      opacity: 1;
    }

    .toast.error {
      background: var(--red);
    }

    .toast.success {
      background: #10B981;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--white);
      border-radius: 8px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-gray);
    }

    /* Cart Item */
    .cart-item {
      display: flex;
      gap: 1rem;
      padding: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .cart-item-image {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 6px;
      background: var(--bg-light);
    }

    .cart-item-info {
      flex: 1;
    }

    .cart-item-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .qty-control {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.25rem;
    }

    .qty-control button {
      background: none;
      border: none;
      padding: 0.25rem 0.5rem;
      cursor: pointer;
      font-size: 1rem;
    }

    /* Loading Skeleton */
    .skeleton {
      background: linear-gradient(90deg, var(--bg-light) 25%, #e0e0e0 50%, var(--bg-light) 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      border-radius: 4px;
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .skeleton-text {
      height: 1rem;
      margin-bottom: 0.5rem;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-gray);
    }

    .empty-state svg {
      width: 80px;
      height: 80px;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    /* Auth Form */
    .auth-container {
      max-width: 400px;
      margin: 2rem auto;
    }

    .auth-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      border-bottom: 2px solid var(--border);
    }

    .auth-tab {
      padding: 0.75rem 1.5rem;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-gray);
      transition: all 0.2s;
    }

    .auth-tab.active {
      color: var(--red);
      border-bottom-color: var(--red);
    }

    .divider {
      display: flex;
      align-items: center;
      text-align: center;
      margin: 1.5rem 0;
      color: var(--text-gray);
      font-size: 0.9rem;
    }

    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      border-bottom: 1px solid var(--border);
    }

    .divider span {
      padding: 0 1rem;
    }

    /* Category Chips */
    .category-chips {
      display: flex;
      gap: 0.5rem;
      overflow-x: auto;
      padding: 1rem 0;
      scrollbar-width: none;
    }

    .category-chips::-webkit-scrollbar {
      display: none;
    }

    .chip {
      padding: 0.5rem 1rem;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 0.9rem;
      white-space: nowrap;
      cursor: pointer;
      transition: all 0.2s;
    }

    .chip.active,
    .chip:hover {
      background: var(--red);
      color: var(--white);
      border-color: var(--red);
    }

    /* Order Item */
    .order-item {
      background: var(--white);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: var(--shadow);
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    .order-status {
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .order-status.pending {
      background: #FEF3C7;
      color: #92400E;
    }

    .order-status.completed {
      background: #D1FAE5;
      color: #065F46;
    }

    .order-status.cancelled {
      background: #FEE2E2;
      color: #991B1B;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .search-bar {
        display: none;
      }

      .product-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }

      .header-actions {
        gap: 0.5rem;
      }
    }

    @media (min-width: 769px) {
      .bottom-nav {
        display: none;
      }

      body {
        padding-bottom: 0;
      }
    }

    /* Image Upload Preview */
    .image-preview-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-top: 1rem;
    }

    .image-preview {
      position: relative;
      aspect-ratio: 1;
      border: 2px dashed var(--border);
      border-radius: 8px;
      overflow: hidden;
      background: var(--bg-light);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .image-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .image-preview-remove {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: var(--red);
      color: var(--white);
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1rem;
    }

    /* Rating Stars */
    .rating-stars {
      display: flex;
      gap: 0.25rem;
    }

    .star {
      cursor: pointer;
      color: var(--text-gray);
      font-size: 1.5rem;
    }

    .star.filled {
      color: var(--gold);
    }

    /* User Menu Dropdown */
    .user-menu {
      position: relative;
    }

    .user-menu-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: var(--shadow-lg);
      min-width: 200px;
      display: none;
      margin-top: 0.5rem;
      z-index: 1000;
    }

    .user-menu-dropdown.show {
      display: block;
    }

    .user-menu-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: background 0.2s;
    }

    .user-menu-item:last-child {
      border-bottom: none;
    }

    .user-menu-item:hover {
      background: var(--bg-light);
    }

    .profile-pic-preview {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--border);
      cursor: pointer;
      margin-bottom: 1rem;
    }

    .profile-pic-placeholder {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: var(--bg-light);
      border: 3px dashed var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin-bottom: 1rem;
      font-size: 2rem;
      color: var(--text-gray);
    }

    /* Category Filter */
    .category-filter {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Header -->
  <header>
    <div class="header-content">
      <a href="#" class="logo" onclick="showSection('home')">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
          <polyline points="9 22 9 12 15 12 15 22"/>
        </svg>
        PinoyCart
      </a>
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Search products...">
        <button onclick="searchProducts()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
          </svg>
        </button>
      </div>
      <div class="header-actions">
        <button class="icon-btn" onclick="showSection('cart')" id="cartBtn">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="9" cy="21" r="1"/>
            <circle cx="20" cy="21" r="1"/>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
          </svg>
          <span class="badge" id="cartBadge">0</span>
        </button>
        <div class="user-menu">
          <button class="icon-btn" onclick="toggleUserMenu()" id="authBtn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
          </button>
          <div class="user-menu-dropdown" id="userMenuDropdown">
            <div class="user-menu-item" onclick="showSection('orders'); toggleUserMenu()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
              </svg>
              Orders
            </div>
            <div class="user-menu-item" onclick="showSection('account'); toggleUserMenu()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="7" r="4"/>
                <path d="M5.5 21a8.38 8.38 0 0 1 13 0"/>
              </svg>
              My Account
            </div>
            <div class="user-menu-item" onclick="showSection('settings'); toggleUserMenu()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M12 1v6m0 6v6m-9-9h6m6 0h6"/>
              </svg>
              Settings
            </div>
            <div class="user-menu-item" onclick="showSection('about'); toggleUserMenu()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="16" x2="12" y2="12"/>
                <line x1="12" y1="8" x2="12.01" y2="8"/>
              </svg>
              About
            </div>
            <div class="user-menu-item" onclick="logout(); toggleUserMenu()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                <polyline points="16 17 21 12 16 7"/>
                <line x1="21" y1="12" x2="9" y2="12"/>
              </svg>
              Logout
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <button class="nav-item active" onclick="showSection('home')">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
      </svg>
      <span>Home</span>
    </button>
    <button class="nav-item" onclick="showSection('cart')">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="9" cy="21" r="1"/>
        <circle cx="20" cy="21" r="1"/>
        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
      </svg>
      <span>Cart</span>
    </button>
    <button class="nav-item" onclick="showSection('orders')">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="7" height="7"/>
        <rect x="14" y="3" width="7" height="7"/>
        <rect x="14" y="14" width="7" height="7"/>
        <rect x="3" y="14" width="7" height="7"/>
      </svg>
      <span>Orders</span>
    </button>
    <button class="nav-item" onclick="showSection('account')">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
        <circle cx="12" cy="7" r="4"/>
      </svg>
      <span>Account</span>
    </button>
  </nav>

  <!-- Home Section -->
  <div id="home" class="section active">
    <div class="container">
      <div class="card">
        <h2>Welcome to PinoyCart</h2>
        <p>Your trusted Filipino marketplace</p>
      </div>
      
      <div class="category-filter">
        <button class="chip active" onclick="filterByCategory('')">All</button>
        <button class="chip" onclick="filterByCategory('Electronics')">Electronics</button>
        <button class="chip" onclick="filterByCategory('Fashion')">Fashion</button>
        <button class="chip" onclick="filterByCategory('Home & Living')">Home & Living</button>
        <button class="chip" onclick="filterByCategory('Food & Beverage')">Food & Beverage</button>
        <button class="chip" onclick="filterByCategory('Health & Beauty')">Health & Beauty</button>
        <button class="chip" onclick="filterByCategory('Sports')">Sports</button>
        <button class="chip" onclick="filterByCategory('Others')">Others</button>
      </div>
      
      <div class="product-grid" id="productGrid"></div>
    </div>
  </div>

  <!-- Auth Section -->
  <div id="auth" class="section">
    <div class="auth-container">
      <div class="card">
        <div class="auth-tabs">
          <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
          <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
        </div>
        
        <div id="loginForm">
          <div class="input-group">
            <label>Email</label>
            <input type="email" id="loginEmail" placeholder="your@email.com">
          </div>
          <div class="input-group">
            <label>Password</label>
            <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>
          <button class="btn btn-primary" style="width:100%" onclick="login()">Login</button>
          
          <div class="divider"><span>OR</span></div>
          
          <button class="btn btn-outline" style="width:100%" onclick="googleSignIn()">
            <svg width="20" height="20" viewBox="0 0 24 24">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Continue with Google
          </button>
        </div>
        
        <div id="signupForm" style="display:none">
          <div class="input-group">
            <label>Username</label>
            <input type="text" id="signupUsername" placeholder="johndoe">
          </div>
          <div class="input-group">
            <label>Email</label>
            <input type="email" id="signupEmail" placeholder="your@email.com">
          </div>
          <div class="input-group">
            <label>Password</label>
            <input type="password" id="signupPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>
          <button class="btn btn-primary" style="width:100%" onclick="signup()">Create Account</button>
          
          <div class="divider"><span>OR</span></div>
          
          <button class="btn btn-outline" style="width:100%" onclick="googleSignIn()">
            <svg width="20" height="20" viewBox="0 0 24 24">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Continue with Google
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Account Section -->
  <div id="account" class="section">
    <div class="container">
      <div class="card">
        <div class="card-header">My Account</div>
        <div id="accountContent"></div>
      </div>
    </div>
  </div>

  <!-- Seller Application Section -->
  <div id="sellerApplication" class="section">
    <div class="container">
      <div class="card">
        <div class="card-header">Apply as Seller</div>
        <div class="input-group">
          <label>Seller Name</label>
          <input type="text" id="sellerName" placeholder="Juan Dela Cruz">
        </div>
        <div class="input-group">
          <label>Shop Name</label>
          <input type="text" id="shopName" placeholder="Juan's Store">
        </div>
        <div class="input-group">
          <label>Contact Number</label>
          <input type="tel" id="contactNumber" placeholder="+63 912 345 6789">
        </div>
        <div class="input-group">
          <label>Email</label>
          <input type="email" id="sellerEmail" placeholder="shop@email.com">
        </div>
        <button class="btn btn-primary" onclick="applyAsSeller()">Submit Application</button>
      </div>
    </div>
  </div>

  <!-- Seller Dashboard -->
  <div id="sellerDashboard" class="section">
    <div class="container">
      <div class="card">
        <div class="card-header">Seller Dashboard</div>
        <button class="btn btn-primary" onclick="showAddProductModal()">Add Product</button>
        <div id="sellerProducts" class="product-grid"></div>
      </div>
    </div>
  </div>

  <!-- Cart Section -->
  <div id="cart" class="section">
    <div class="container">
      <div class="card">
        <div class="card-header">Shopping Cart</div>
        <div id="cartItems"></div>
        <div id="cartSummary"></div>
      </div>
    </div>
  </div>

  <!-- Checkout Section -->
  <div id="checkout" class="section">
    <div class="container">
      <div class="card">
        <div class="card-header">Checkout</div>
        <div id="checkoutContent"></div>
      </div>
    </div>
  </div>

  <!-- Orders Section -->
  <div id="orders" class="section">
    <div class="container">
      <div class="card">
        <div class="card-header">My Orders</div>
        <div id="ordersList"></div>
      </div>
    </div>
  </div>

  <!-- Settings Section -->
  <div id="settings" class="section">
    <div class="container">
      <div class="card">
        <div class="card-header">Settings</div>
        <div id="settingsContent">
          <div style="display:grid;gap:1.5rem">
            <!-- Profile Picture -->
            <div style="text-align:center">
              <div id="profilePicContainer"></div>
              <input type="file" id="profilePicUpload" accept="image/*" style="display:none" onchange="handleProfilePicUpload()">
            </div>

            <!-- Username -->
            <div>
              <h4 style="margin-bottom:1rem">Change Username</h4>
              <div class="input-group">
                <label>New Username</label>
                <input type="text" id="newUsername" placeholder="New username">
              </div>
              <button class="btn btn-primary" onclick="updateUsername()">Update Username</button>
            </div>

            <!-- Password -->
            <div style="border-top:1px solid var(--border);padding-top:1rem">
              <h4 style="margin-bottom:1rem">Change Password</h4>
              <div class="input-group">
                <label>Current Password</label>
                <input type="password" id="currentPassword" placeholder="Current password">
              </div>
              <div class="input-group">
                <label>New Password</label>
                <input type="password" id="newPassword" placeholder="New password">
              </div>
              <div class="input-group">
                <label>Confirm New Password</label>
                <input type="password" id="confirmPassword" placeholder="Confirm password">
              </div>
              <button class="btn btn-primary" onclick="updatePasswordUser()">Update Password</button>
            </div>

            <!-- Theme -->
            <div style="border-top:1px solid var(--border);padding-top:1rem">
              <h4 style="margin-bottom:1rem">Interface Theme</h4>
              <div style="display:flex;gap:1rem">
                <button class="btn btn-outline" onclick="setTheme('light')" id="lightThemeBtn">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"/>
                    <line x1="12" y1="1" x2="12" y2="3"/>
                    <line x1="12" y1="21" x2="12" y2="23"/>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                    <line x1="1" y1="12" x2="3" y2="12"/>
                    <line x1="21" y1="12" x2="23" y2="12"/>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                  </svg>
                  Light Mode
                </button>
                <button class="btn btn-outline" onclick="setTheme('dark')" id="darkThemeBtn">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                  </svg>
                  Dark Mode
                </button>
              </div>
            </div>

            <!-- Billing Address -->
            <div style="border-top:1px solid var(--border);padding-top:1rem">
              <h4 style="margin-bottom:1rem">Billing Address</h4>
              <div class="input-group">
                <label>Full Name</label>
                <input type="text" id="settingsBillingName" placeholder="Juan Dela Cruz">
              </div>
              <div class="input-group">
                <label>Address</label>
                <textarea id="settingsBillingAddress" placeholder="Complete address"></textarea>
              </div>
              <div class="input-group">
                <label>Phone</label>
                <input type="tel" id="settingsBillingPhone" placeholder="+63 912 345 6789">
              </div>
              <button class="btn btn-primary" onclick="updateBillingInfo()">Update Billing Info</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="section">
    <div class="container">
      <div class="card">
        <div class="card-header">Admin Panel</div>
        <div style="display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap">
          <button class="btn btn-outline" onclick="showAdminTab('sellers')">Pending Sellers</button>
          <button class="btn btn-outline" onclick="showAdminTab('users')">All Users</button>
          <button class="btn btn-outline" onclick="showAdminTab('vouchers')">Vouchers & Shipping Fees</button>
        </div>
        <div id="adminContent"></div>
      </div>
    </div>
  </div>

  <!-- Cancel Order Modal -->
  <div id="cancelOrderModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Cancel Order</h3>
        <button class="modal-close" onclick="closeModal('cancelOrderModal')">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="cancelOrderId">
        <div class="input-group">
          <label>Reason for Cancellation</label>
          <select id="cancelReason">
            <option value="">Select a reason</option>
            <option value="Changed my mind">Changed my mind</option>
            <option value="Found a better price">Found a better price</option>
            <option value="Ordered by mistake">Ordered by mistake</option>
            <option value="Delivery takes too long">Delivery takes too long</option>
            <option value="Payment issues">Payment issues</option>
            <option value="Product no longer needed">Product no longer needed</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="input-group" id="otherReasonGroup" style="display:none">
          <label>Please specify</label>
          <textarea id="otherReason" placeholder="Enter your reason..."></textarea>
        </div>
        <button class="btn btn-primary" onclick="confirmCancelOrder()">Confirm Cancellation</button>
      </div>
    </div>
  </div>

  <!-- Create Voucher Modal -->
  <div id="createVoucherModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Create Voucher</h3>
        <button class="modal-close" onclick="closeModal('createVoucherModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="input-group">
          <label>Voucher Code</label>
          <input type="text" id="voucherCode" placeholder="SAVE10" style="text-transform:uppercase">
        </div>
        <div class="input-group">
          <label>Type</label>
          <select id="voucherType">
            <option value="percentage">Percentage</option>
            <option value="fixed">Fixed Amount</option>
          </select>
        </div>
        <div class="input-group">
          <label>Amount</label>
          <input type="number" id="voucherAmount" placeholder="10" step="0.01">
          <small style="color:var(--text-gray)">For percentage: enter 10 for 10%, for fixed: enter amount in PHP</small>
        </div>
        <div class="input-group">
          <label>Minimum Spend (‚Ç±)</label>
          <input type="number" id="voucherMinSpend" placeholder="0" step="0.01">
        </div>
        <div class="input-group">
          <label>Usage Limit (0 = unlimited)</label>
          <input type="number" id="voucherUsageLimit" placeholder="0">
        </div>
        <div class="input-group">
          <label>Per User Limit (0 = unlimited)</label>
          <input type="number" id="voucherPerUserLimit" placeholder="1">
        </div>
        <div class="input-group">
          <label>Expires At</label>
          <input type="datetime-local" id="voucherExpiry">
        </div>
        <button class="btn btn-primary" onclick="createVoucher()">Create Voucher</button>
      </div>
    </div>
  </div>

  <!-- About Section -->
  <div id="about" class="section">
    <div class="container">
      <div class="card">
        <div class="card-header">About PinoyCart</div>
        <div style="line-height:1.8;color:var(--text-dark)">
          <p style="margin-bottom:1.5rem">
            <strong>PinoyCart</strong> is a comprehensive e-commerce platform designed specifically for Filipino businesses and consumers. Our mission is to provide a seamless online marketplace that connects local sellers with customers across the Philippines, making it easier than ever to buy and sell products online. With features like secure payment processing, real-time inventory management, and an intuitive user interface, PinoyCart empowers entrepreneurs to grow their businesses while providing shoppers with a convenient and trustworthy platform for their purchases.
          </p>
          
          <p style="margin-bottom:1.5rem">
            Built with modern web technologies and Firebase integration, PinoyCart offers a robust and scalable solution for online retail. The platform includes advanced features such as seller account management, product categorization, shopping cart functionality, order tracking, voucher systems, and user ratings. Whether you're a small business owner looking to expand your reach or a customer searching for quality products, PinoyCart provides the tools and features you need for a successful e-commerce experience.
          </p>

          <p style="margin-bottom:1.5rem">
            PinoyCart is available both as a <strong>responsive web application</strong> accessible from any browser and as a <strong>mobile application</strong> for Android devices, ensuring you can shop or manage your store anytime, anywhere. Our commitment to user experience, security, and continuous improvement makes PinoyCart the ideal choice for the modern Filipino marketplace.
          </p>

          <div style="border-top:2px solid var(--border);margin:2rem 0;padding-top:2rem">
            <h3 style="color:var(--blue);margin-bottom:1rem;font-size:1.1rem">Development Team</h3>
            <p style="margin-bottom:1rem;font-weight:600;color:var(--text-dark)">
              This is Designed and Developed by:
            </p>
            <ul style="list-style:none;padding-left:1rem;margin-bottom:2rem">
              <li style="margin-bottom:0.5rem;display:flex;align-items:center">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right:0.5rem;color:var(--red)">
                  <circle cx="12" cy="12" r="10"/>
                </svg>
                <strong>Steven Macapa√±as</strong>
              </li>
              <li style="margin-bottom:0.5rem;display:flex;align-items:center">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right:0.5rem;color:var(--red)">
                  <circle cx="12" cy="12" r="10"/>
                </svg>
                <strong>Leo Grabrino</strong>
              </li>
              <li style="margin-bottom:0.5rem;display:flex;align-items:center">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right:0.5rem;color:var(--red)">
                  <circle cx="12" cy="12" r="10"/>
                </svg>
                <strong>Cathylyn Abueva</strong>
              </li>
              <li style="margin-bottom:0.5rem;display:flex;align-items:center">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right:0.5rem;color:var(--red)">
                  <circle cx="12" cy="12" r="10"/>
                </svg>
                <strong>Charles Glenn Avila</strong>
              </li>
              <li style="margin-bottom:0.5rem;display:flex;align-items:center">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right:0.5rem;color:var(--red)">
                  <circle cx="12" cy="12" r="10"/>
                </svg>
                <strong>Charles Abaigar</strong>
              </li>
            </ul>
          </div>

          <div style="background:var(--bg-light);padding:1.5rem;border-radius:8px;border-left:4px solid var(--blue);margin-bottom:2rem">
            <p style="font-weight:600;color:var(--text-dark);margin-bottom:0.5rem">
              üìö Academic Submission
            </p>
            <p style="color:var(--text-gray)">
              This project is being submitted by the developers to <strong style="color:var(--text-dark)">Mr. Felix Carlos Uy</strong>.
            </p>
          </div>

          <div style="text-align:center;padding:2rem;background:linear-gradient(135deg, var(--red), var(--blue));border-radius:8px">
            <h4 style="color:var(--white);margin-bottom:1rem;font-size:1.2rem">Download Mobile App</h4>
            <p style="color:var(--white);margin-bottom:1.5rem;opacity:0.9">
              Get the PinoyCart mobile application for Android devices
            </p>
            <a href="pinoycart.apk" download="pinoycart.apk" class="btn" style="background:var(--white);color:var(--red);text-decoration:none;display:inline-flex;font-weight:700">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:0.5rem">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Download APK (Android)
            </a>
            <p style="color:var(--white);margin-top:1rem;font-size:0.85rem;opacity:0.8">
              Version 1.0.0 ‚Ä¢ Size: ~5MB
            </p>
          </div>

          <div style="margin-top:2rem;padding-top:2rem;border-top:1px solid var(--border);text-align:center;color:var(--text-gray);font-size:0.9rem">
            <p>¬© 2025 PinoyCart. All rights reserved.</p>
            <p style="margin-top:0.5rem">Made with ‚ù§Ô∏è for the Filipino Community</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Detail Modal -->
  <div id="productModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="productModalTitle"></h3>
        <button class="modal-close" onclick="closeModal('productModal')">&times;</button>
      </div>
      <div class="modal-body" id="productModalBody"></div>
    </div>
  </div>

  <!-- Add/Edit Product Modal -->
  <div id="addProductModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="productFormTitle">Add Product</h3>
        <button class="modal-close" onclick="closeModal('addProductModal')">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editProductId">
        <div class="input-group">
          <label>Product Name</label>
          <input type="text" id="productName" placeholder="Product Name">
        </div>
        <div class="input-group">
          <label>Price (‚Ç±)</label>
          <input type="number" id="productPrice" placeholder="0.00" step="0.01">
        </div>
        <div class="input-group">
          <label>Stock</label>
          <input type="number" id="productStock" placeholder="0">
        </div>
        <div class="input-group">
          <label>Description</label>
          <textarea id="productDescription" placeholder="Product description..."></textarea>
        </div>
        <div class="input-group">
          <label>Variants (comma-separated, optional)</label>
          <input type="text" id="productVariants" placeholder="Small, Medium, Large">
        </div>
        <div class="input-group">
          <label>Category</label>
          <select id="productCategory">
            <option value="">Select category</option>
            <option value="Electronics">Electronics</option>
            <option value="Fashion">Fashion</option>
            <option value="Home & Living">Home & Living</option>
            <option value="Food & Beverage">Food & Beverage</option>
            <option value="Health & Beauty">Health & Beauty</option>
            <option value="Sports">Sports</option>
            <option value="Others">Others</option>
          </select>
        </div>
        <div class="input-group">
          <label>Images (up to 3)</label>
          <div class="image-preview-grid" id="imagePreviewGrid">
            <div class="image-preview" onclick="triggerImageUpload(0)">
              <span>+</span>
              <input type="file" id="imageUpload0" accept="image/*" style="display:none" onchange="handleImageUpload(0)">
            </div>
            <div class="image-preview" onclick="triggerImageUpload(1)">
              <span>+</span>
              <input type="file" id="imageUpload1" accept="image/*" style="display:none" onchange="handleImageUpload(1)">
            </div>
            <div class="image-preview" onclick="triggerImageUpload(2)">
              <span>+</span>
              <input type="file" id="imageUpload2" accept="image/*" style="display:none" onchange="handleImageUpload(2)">
            </div>
          </div>
        </div>
        <button class="btn btn-primary" onclick="saveProduct()">Save Product</button>
      </div>
    </div>
  </div>

  <!-- Rating Modal -->
  <div id="ratingModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Rate Product</h3>
        <button class="modal-close" onclick="closeModal('ratingModal')">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="ratingProductId">
        <div class="rating-stars" id="ratingStars"></div>
        <div class="input-group">
          <label>Comment</label>
          <textarea id="ratingComment" placeholder="Share your experience..."></textarea>
        </div>
        <button class="btn btn-primary" onclick="submitRating()">Submit Rating</button>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase Imports
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, updateProfile, updateEmail, updatePassword, reauthenticateWithCredential, EmailAuthProvider } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, collection, query, where, orderBy, limit, serverTimestamp, runTransaction, writeBatch, arrayUnion } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBOTajyBGmJ0isYijswBxpmnQYPc77TQEQ",
      authDomain: "pinoycart-8f39e.firebaseapp.com",
      projectId: "pinoycart-8f39e",
      storageBucket: "pinoycart-8f39e.firebasestorage.app",
      messagingSenderId: "116180067692",
      appId: "1:116180067692:web:6a6f12e76d0320f3e5bf49",
      measurementId: "G-GB06467F1N"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Global State
    let currentUser = null;
    let userProfile = null;
    let currentCart = [];
    let productImages = ['', '', ''];
    let currentRating = 0;
    let currentCategory = '';
    let searchQuery = '';
    let currentAdminTab = 'sellers';

    // Show Toast
    window.showToast = (message, type = 'info') => {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => toast.classList.remove('show'), 3000);
    };

    // Toggle User Menu
    window.toggleUserMenu = () => {
      if (!currentUser) {
        showSection('auth');
        return;
      }
      
      const dropdown = document.getElementById('userMenuDropdown');
      dropdown.classList.toggle('show');
    };

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const userMenu = document.querySelector('.user-menu');
      const dropdown = document.getElementById('userMenuDropdown');
      if (!userMenu?.contains(e.target)) {
        dropdown?.classList.remove('show');
      }
    });

    // Show Section
    window.showSection = (sectionId) => {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
      document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
      
      if (sectionId === 'home') loadProducts();
      if (sectionId === 'cart') loadCart();
      if (sectionId === 'account') loadAccount();
      if (sectionId === 'orders') loadOrders();
      if (sectionId === 'settings') loadSettings();
      if (sectionId === 'sellerDashboard') loadSellerProducts();
      if (sectionId === 'adminPanel') loadAdminPanel();
    };

    // Modal Functions
    window.closeModal = (modalId) => {
      document.getElementById(modalId).classList.remove('active');
    };

    // Auth Functions
    window.switchAuthTab = (tab) => {
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      if (tab === 'login') {
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('signupForm').style.display = 'none';
      } else {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('signupForm').style.display = 'block';
      }
    };

    window.signup = async () => {
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      const username = document.getElementById('signupUsername').value;

      if (!email || !password || !username) {
        showToast('Please fill all fields', 'error');
        return;
      }

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        await updateProfile(userCredential.user, { displayName: username });
        
        await setDoc(doc(db, 'users', userCredential.user.uid), {
          email,
          username,
          role: 'user',
          coins: 0,
          createdAt: serverTimestamp()
        });

        await setDoc(doc(db, 'carts', userCredential.user.uid), {
          items: [],
          updatedAt: serverTimestamp()
        });

        showToast('Account created successfully!', 'success');
        showSection('home');
      } catch (error) {
        showToast(error.message, 'error');
      }
    };

    window.login = async () => {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      if (!email || !password) {
        showToast('Please fill all fields', 'error');
        return;
      }

      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        
        // Check if user is suspended
        const userDoc = await getDoc(doc(db, 'users', userCredential.user.uid));
        if (userDoc.exists() && userDoc.data().suspended) {
          await signOut(auth);
          showToast('Your account has been suspended. Please contact support.', 'error');
          return;
        }
        
        showToast('Logged in successfully!', 'success');
        showSection('home');
      } catch (error) {
        showToast(error.message, 'error');
      }
    };

    window.googleSignIn = async () => {
      const provider = new GoogleAuthProvider();
      try {
        const result = await signInWithPopup(auth, provider);
        const userDoc = await getDoc(doc(db, 'users', result.user.uid));
        
        if (!userDoc.exists()) {
          await setDoc(doc(db, 'users', result.user.uid), {
            email: result.user.email,
            username: result.user.displayName,
            role: 'user',
            coins: 0,
            createdAt: serverTimestamp()
          });

          await setDoc(doc(db, 'carts', result.user.uid), {
            items: [],
            updatedAt: serverTimestamp()
          });
        } else if (userDoc.data().suspended) {
          // Check if user is suspended
          await signOut(auth);
          showToast('Your account has been suspended. Please contact support.', 'error');
          return;
        }

        showToast('Logged in successfully!', 'success');
        showSection('home');
      } catch (error) {
        showToast(error.message, 'error');
      }
    };

    window.logout = async () => {
      try {
        await signOut(auth);
        showToast('Logged out successfully', 'success');
        showSection('home');
      } catch (error) {
        showToast(error.message, 'error');
      }
    };

    // Load Products
    window.loadProducts = async (category = '', search = '') => {
      const grid = document.getElementById('productGrid');
      grid.innerHTML = '<div class="skeleton" style="height:300px"></div>'.repeat(6);

      try {
        let q = query(collection(db, 'products'), where('active', '==', true));
        
        if (category) {
          q = query(collection(db, 'products'), where('active', '==', true), where('category', '==', category));
        }
        
        const snapshot = await getDocs(q);
        
        let products = [];
        snapshot.forEach(doc => {
          products.push({ id: doc.id, ...doc.data() });
        });

        // Filter by search query
        if (search) {
          const searchLower = search.toLowerCase();
          products = products.filter(p => 
            p.name.toLowerCase().includes(searchLower) || 
            p.description?.toLowerCase().includes(searchLower)
          );
        }
        
        if (products.length === 0) {
          grid.innerHTML = '<div class="empty-state"><p>No products available</p></div>';
          return;
        }

        grid.innerHTML = '';
        products.forEach(product => {
          const card = createProductCard(product);
          grid.appendChild(card);
        });
      } catch (error) {
        showToast('Error loading products', 'error');
        grid.innerHTML = '<div class="empty-state"><p>Error loading products</p></div>';
      }
    };

    window.filterByCategory = (category) => {
      currentCategory = category;
      document.querySelectorAll('.category-filter .chip').forEach(chip => {
        chip.classList.remove('active');
      });
      event.target.classList.add('active');
      loadProducts(category, searchQuery);
    };

    window.searchProducts = () => {
      searchQuery = document.getElementById('searchInput').value;
      loadProducts(currentCategory, searchQuery);
    };

    // Add enter key support for search
    document.addEventListener('DOMContentLoaded', () => {
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            searchProducts();
          }
        });
      }
    });

    function createProductCard(product) {
      const card = document.createElement('div');
      card.className = 'product-card';
      card.onclick = () => showProductDetail(product);

      const avgRating = product.ratings?.length > 0 
        ? (product.ratings.reduce((a, b) => a + b.rating, 0) / product.ratings.length).toFixed(1)
        : 'No ratings';

      card.innerHTML = `
        <img src="${product.images?.[0] || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect fill="%23f0f0f0" width="200" height="200"/%3E%3C/svg%3E'}" 
             alt="${product.name}" class="product-image">
        <div class="product-info">
          <div class="product-name">${product.name}</div>
          <div class="product-price">‚Ç±${parseFloat(product.price).toFixed(2)}</div>
          <div style="font-size:0.85rem;color:var(--text-gray)">
            ‚≠ê ${avgRating} ${product.ratings?.length ? `(${product.ratings.length})` : ''}
          </div>
          <div class="product-actions" onclick="event.stopPropagation()">
            <button class="btn btn-primary" style="flex:1;padding:0.5rem" onclick="addToCart('${product.id}')">Add to Cart</button>
          </div>
        </div>
      `;
      return card;
    }

    window.showProductDetail = async (product) => {
      const modal = document.getElementById('productModal');
      const title = document.getElementById('productModalTitle');
      const body = document.getElementById('productModalBody');

      title.textContent = product.name;

      const avgRating = product.ratings?.length > 0 
        ? (product.ratings.reduce((a, b) => a + b.rating, 0) / product.ratings.length).toFixed(1)
        : 0;

      body.innerHTML = `
        <div style="display:grid;gap:1rem">
          ${product.images?.filter(img => img).map(img => 
            `<img src="${img}" style="width:100%;border-radius:8px" alt="${product.name}">`
          ).join('') || '<div style="height:300px;background:var(--bg-light);border-radius:8px"></div>'}
          
          <div>
            <div style="font-size:2rem;font-weight:700;color:var(--red);margin-bottom:0.5rem">
              ‚Ç±${parseFloat(product.price).toFixed(2)}
            </div>
            <div style="margin-bottom:1rem;color:var(--text-gray)">
              ‚≠ê ${avgRating} ${product.ratings?.length ? `(${product.ratings.length} ratings)` : '(No ratings yet)'}
            </div>
            <p style="margin-bottom:1rem">${product.description}</p>
            <div style="color:var(--text-gray);margin-bottom:1rem">Stock: ${product.stock}</div>
            
            ${product.variants?.length > 0 ? `
              <div class="input-group">
                <label>Select Variant</label>
                <select id="selectedVariant">
                  ${product.variants.map(v => `<option value="${v}">${v}</option>`).join('')}
                </select>
              </div>
            ` : ''}
            
            <div class="input-group">
              <label>Quantity</label>
              <div class="qty-control">
                <button onclick="changeQty(-1)">-</button>
                <input type="number" id="productQty" value="1" min="1" max="${product.stock}" style="width:60px;text-align:center;border:none">
                <button onclick="changeQty(1)">+</button>
              </div>
            </div>
            
            <button class="btn btn-primary" style="width:100%" onclick="addToCart('${product.id}')">Add to Cart</button>
          </div>

          ${product.ratings?.length > 0 ? `
            <div style="border-top:1px solid var(--border);padding-top:1rem">
              <h4 style="margin-bottom:1rem">Customer Reviews</h4>
              ${product.ratings.map(r => `
                <div style="padding:1rem;background:var(--bg-light);border-radius:6px;margin-bottom:0.5rem">
                  <div style="display:flex;gap:0.5rem;margin-bottom:0.5rem">
                    ${'‚≠ê'.repeat(r.rating)}${'‚òÜ'.repeat(5-r.rating)}
                  </div>
                  <div style="font-size:0.9rem">${r.comment || ''}</div>
                  <div style="font-size:0.8rem;color:var(--text-gray);margin-top:0.5rem">
                    ${r.username} - ${new Date(r.createdAt?.toDate()).toLocaleDateString()}
                  </div>
                </div>
              `).join('')}
            </div>
          ` : ''}
        </div>
      `;

      modal.classList.add('active');
    };

    window.changeQty = (delta) => {
      const input = document.getElementById('productQty');
      const newVal = parseInt(input.value) + delta;
      if (newVal >= 1 && newVal <= parseInt(input.max)) {
        input.value = newVal;
      }
    };

    window.addToCart = async (productId) => {
      if (!currentUser) {
        showToast('Please login to add items to cart', 'error');
        showSection('auth');
        return;
      }

      // Check if user is suspended
      if (userProfile?.suspended) {
        await signOut(auth);
        showToast('Your account has been suspended. Please contact support.', 'error');
        showSection('auth');
        return;
      }

      try {
        const productDoc = await getDoc(doc(db, 'products', productId));
        if (!productDoc.exists()) {
          showToast('Product not found', 'error');
          return;
        }

        const product = productDoc.data();
        const qtyInput = document.getElementById('productQty');
        const qty = qtyInput ? parseInt(qtyInput.value) : 1;
        const variantSelect = document.getElementById('selectedVariant');
        const variant = variantSelect ? variantSelect.value : '';

        if (qty > product.stock) {
          showToast('Not enough stock', 'error');
          return;
        }

        const cartRef = doc(db, 'carts', currentUser.uid);
        const cartDoc = await getDoc(cartRef);
        let items = cartDoc.exists() ? cartDoc.data().items || [] : [];

        const existingIndex = items.findIndex(i => i.productId === productId && i.variant === variant);
        
        if (existingIndex >= 0) {
          items[existingIndex].qty += qty;
        } else {
          items.push({
            productId,
            name: product.name,
            price: product.price,
            variant,
            qty,
            image: product.images?.[0] || ''
          });
        }

        await setDoc(cartRef, { items, updatedAt: serverTimestamp() });
        
        showToast('Added to cart!', 'success');
        updateCartBadge();
        closeModal('productModal');
      } catch (error) {
        showToast('Error adding to cart', 'error');
      }
    };

    window.loadCart = async () => {
      const container = document.getElementById('cartItems');
      const summary = document.getElementById('cartSummary');

      if (!currentUser) {
        container.innerHTML = '<div class="empty-state"><p>Please login to view cart</p></div>';
        summary.innerHTML = '';
        return;
      }

      try {
        const cartDoc = await getDoc(doc(db, 'carts', currentUser.uid));
        const items = cartDoc.exists() ? cartDoc.data().items || [] : [];

        if (items.length === 0) {
          container.innerHTML = '<div class="empty-state"><p>Your cart is empty</p></div>';
          summary.innerHTML = '';
          return;
        }

        container.innerHTML = items.map((item, index) => `
          <div class="cart-item">
            <img src="${item.image || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="80" height="80"%3E%3Crect fill="%23f0f0f0" width="80" height="80"/%3E%3C/svg%3E'}" 
                 alt="${item.name}" class="cart-item-image">
            <div class="cart-item-info">
              <div style="font-weight:600">${item.name}</div>
              ${item.variant ? `<div style="font-size:0.85rem;color:var(--text-gray)">${item.variant}</div>` : ''}
              <div style="color:var(--red);font-weight:600;margin-top:0.5rem">‚Ç±${parseFloat(item.price).toFixed(2)}</div>
            </div>
            <div class="cart-item-actions">
              <div class="qty-control">
                <button onclick="updateCartQty(${index}, -1)">-</button>
                <span style="padding:0 0.5rem">${item.qty}</span>
                <button onclick="updateCartQty(${index}, 1)">+</button>
              </div>
              <button class="icon-btn" onclick="removeFromCart(${index})">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"/>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
              </button>
            </div>
          </div>
        `).join('');

        const subtotal = items.reduce((sum, item) => sum + (item.price * item.qty), 0);

        summary.innerHTML = `
          <div style="border-top:1px solid var(--border);padding-top:1rem;margin-top:1rem">
            <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem">
              <span>Subtotal:</span>
              <span style="font-weight:600">‚Ç±${subtotal.toFixed(2)}</span>
            </div>
            <div id="discountDisplay" style="display:none;margin-bottom:0.5rem">
              <div style="display:flex;justify-content:space-between;color:green">
                <span>Discount (<span id="appliedVoucherCode"></span>):</span>
                <span style="font-weight:600">-‚Ç±<span id="discountAmount">0.00</span></span>
              </div>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:1rem;font-size:1.1rem;font-weight:700">
              <span>Total:</span>
              <span style="color:var(--red)" id="cartTotal">‚Ç±${subtotal.toFixed(2)}</span>
            </div>
            <div class="input-group">
              <input type="text" id="voucherCode" placeholder="Enter voucher code" style="text-transform:uppercase">
            </div>
            <div style="display:flex;gap:0.5rem;margin-bottom:1rem">
              <button class="btn btn-outline" style="flex:1" onclick="applyVoucher()">Apply Voucher</button>
              <button class="btn btn-outline" id="removeVoucherBtn" style="display:none" onclick="removeVoucher()">Remove</button>
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="proceedToCheckout()">Proceed to Checkout</button>
          </div>
        `;
      } catch (error) {
        showToast('Error loading cart', 'error');
      }
    };

    let appliedVoucher = null;

    window.applyVoucher = async () => {
      const voucherCodeInput = document.getElementById('voucherCode');
      const code = voucherCodeInput.value.trim().toUpperCase();

      if (!code) {
        showToast('Please enter a voucher code', 'error');
        return;
      }

      try {
        // Get voucher from Firestore
        const voucherDoc = await getDoc(doc(db, 'vouchers', code));

        if (!voucherDoc.exists()) {
          showToast('Invalid voucher code', 'error');
          return;
        }

        const voucher = voucherDoc.data();

        // Validate voucher
        if (!voucher.active) {
          showToast('This voucher is not active', 'error');
          return;
        }

        // Check expiry
        if (voucher.expiresAt && new Date(voucher.expiresAt) < new Date()) {
          showToast('This voucher has expired', 'error');
          return;
        }

        // Check usage limit
        if (voucher.usageLimit && voucher.usedCount >= voucher.usageLimit) {
          showToast('This voucher has reached its usage limit', 'error');
          return;
        }

        // Get cart items
        const cartDoc = await getDoc(doc(db, 'carts', currentUser.uid));
        const items = cartDoc.data().items || [];
        const subtotal = items.reduce((sum, item) => sum + (item.price * item.qty), 0);

        // Check minimum spend
        if (voucher.minSpend && subtotal < voucher.minSpend) {
          showToast(`Minimum spend of ‚Ç±${voucher.minSpend.toFixed(2)} required`, 'error');
          return;
        }

        // Check per user limit
        if (voucher.perUserLimit) {
          const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
          const vouchersUsed = userDoc.data().vouchersUsed || {};
          const userUsageCount = vouchersUsed[code] || 0;
          
          if (userUsageCount >= voucher.perUserLimit) {
            showToast('You have reached the usage limit for this voucher', 'error');
            return;
          }
        }

        // Calculate discount
        let discount = 0;
        if (voucher.type === 'percentage') {
          discount = (subtotal * voucher.amount) / 100;
        } else {
          discount = voucher.amount;
        }

        // Ensure discount doesn't exceed subtotal
        discount = Math.min(discount, subtotal);

        // Apply voucher
        appliedVoucher = { ...voucher, code, discount };

        // Update UI
        document.getElementById('discountDisplay').style.display = 'flex';
        document.getElementById('appliedVoucherCode').textContent = code;
        document.getElementById('discountAmount').textContent = discount.toFixed(2);
        document.getElementById('cartTotal').textContent = `‚Ç±${(subtotal - discount).toFixed(2)}`;
        document.getElementById('removeVoucherBtn').style.display = 'block';
        voucherCodeInput.disabled = true;

        showToast('Voucher applied successfully!', 'success');
      } catch (error) {
        showToast('Error applying voucher', 'error');
        console.error(error);
      }
    };

    window.removeVoucher = () => {
      appliedVoucher = null;
      
      // Recalculate without discount
      const cartDoc = getDoc(doc(db, 'carts', currentUser.uid)).then(doc => {
        const items = doc.data().items || [];
        const subtotal = items.reduce((sum, item) => sum + (item.price * item.qty), 0);
        
        document.getElementById('discountDisplay').style.display = 'none';
        document.getElementById('cartTotal').textContent = `‚Ç±${subtotal.toFixed(2)}`;
        document.getElementById('removeVoucherBtn').style.display = 'none';
        document.getElementById('voucherCode').value = '';
        document.getElementById('voucherCode').disabled = false;
        
        showToast('Voucher removed', 'success');
      });
    };

    window.updateCartQty = async (index, delta) => {
      try {
        const cartRef = doc(db, 'carts', currentUser.uid);
        const cartDoc = await getDoc(cartRef);
        let items = cartDoc.data().items;

        items[index].qty += delta;
        if (items[index].qty <= 0) {
          items.splice(index, 1);
        }

        await updateDoc(cartRef, { items, updatedAt: serverTimestamp() });
        
        // Clear voucher when cart changes
        if (appliedVoucher) {
          removeVoucher();
        }
        
        loadCart();
        updateCartBadge();
      } catch (error) {
        showToast('Error updating cart', 'error');
      }
    };

    window.removeFromCart = async (index) => {
      try {
        const cartRef = doc(db, 'carts', currentUser.uid);
        const cartDoc = await getDoc(cartRef);
        let items = cartDoc.data().items;

        items.splice(index, 1);
        await updateDoc(cartRef, { items, updatedAt: serverTimestamp() });
        
        // Clear voucher when cart changes
        if (appliedVoucher) {
          appliedVoucher = null;
        }
        
        loadCart();
        updateCartBadge();
        showToast('Item removed', 'success');
      } catch (error) {
        showToast('Error removing item', 'error');
      }
    };

    window.updateCartBadge = async () => {
      if (!currentUser) {
        document.getElementById('cartBadge').textContent = '0';
        return;
      }

      try {
        const cartDoc = await getDoc(doc(db, 'carts', currentUser.uid));
        const items = cartDoc.exists() ? cartDoc.data().items || [] : [];
        const total = items.reduce((sum, item) => sum + item.qty, 0);
        document.getElementById('cartBadge').textContent = total;
      } catch (error) {
        console.error('Error updating cart badge:', error);
      }
    };

    window.proceedToCheckout = async () => {
      const cartDoc = await getDoc(doc(db, 'carts', currentUser.uid));
      const items = cartDoc.data().items || [];

      if (items.length === 0) {
        showToast('Cart is empty', 'error');
        return;
      }

      // Preserve applied voucher when going to checkout
      showSection('checkout');
      await loadCheckout();
    };

    window.loadCheckout = async () => {
      const container = document.getElementById('checkoutContent');
      
      const cartDoc = await getDoc(doc(db, 'carts', currentUser.uid));
      const items = cartDoc.data().items || [];
      const subtotal = items.reduce((sum, item) => sum + (item.price * item.qty), 0);
      
      // Calculate discount from applied voucher
      const discount = appliedVoucher ? appliedVoucher.discount : 0;
      
      // Get shipping settings
      const settingsDoc = await getDoc(doc(db, 'settings', 'shipping'));
      const shippingSettings = settingsDoc.exists() ? settingsDoc.data() : { freeShipping: false, codFee: 50 };

      const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
      const billing = userDoc.data().billing || {};

      container.innerHTML = `
        <div style="display:grid;gap:1.5rem">
          <div>
            <h4 style="margin-bottom:1rem">Billing Information</h4>
            <div class="input-group">
              <label>Full Name</label>
              <input type="text" id="billingName" value="${billing.name || ''}" placeholder="Juan Dela Cruz">
            </div>
            <div class="input-group">
              <label>Address</label>
              <textarea id="billingAddress" placeholder="Complete address">${billing.address || ''}</textarea>
            </div>
            <div class="input-group">
              <label>Phone</label>
              <input type="tel" id="billingPhone" value="${billing.phone || ''}" placeholder="+63 912 345 6789">
            </div>
          </div>

          <div>
            <h4 style="margin-bottom:1rem">Payment Method</h4>
            <div class="input-group">
              <select id="paymentMethod" onchange="updateCheckoutTotal()">
                <option value="">Select payment method</option>
                <option value="bank">Bank Transfer</option>
                <option value="gcash">GCash</option>
                <option value="cod">Cash on Delivery</option>
              </select>
            </div>
            <div id="paymentFields"></div>
          </div>

          <div>
            <h4 style="margin-bottom:1rem">Order Summary</h4>
            ${items.map(item => `
              <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem">
                <span>${item.name} ${item.variant ? `(${item.variant})` : ''} x${item.qty}</span>
                <span>‚Ç±${(item.price * item.qty).toFixed(2)}</span>
              </div>
            `).join('')}
            <div style="border-top:1px solid var(--border);margin-top:1rem;padding-top:1rem" id="checkoutSummary">
              <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem">
                <span>Subtotal:</span>
                <span>‚Ç±${subtotal.toFixed(2)}</span>
              </div>
              ${discount > 0 ? `
                <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;color:green">
                  <span>Discount (${appliedVoucher.code}):</span>
                  <span>-‚Ç±${discount.toFixed(2)}</span>
                </div>
              ` : ''}
              <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem" id="shippingFeeDisplay" style="display:none">
                <span>Shipping Fee:</span>
                <span id="shippingFeeAmount">‚Ç±0.00</span>
              </div>
              <div style="display:flex;justify-content:space-between;font-weight:600;font-size:1.25rem">
                <span>Total:</span>
                <span style="color:var(--red)" id="checkoutTotal">‚Ç±${(subtotal - discount).toFixed(2)}</span>
              </div>
            </div>
          </div>

          <button class="btn btn-primary" style="width:100%" onclick="placeOrder()">Place Order</button>
        </div>
      `;
      
      // Store shipping settings globally for access
      window.shippingSettings = shippingSettings;
    };

    window.updateCheckoutTotal = async () => {
      const paymentMethod = document.getElementById('paymentMethod').value;
      
      // Toggle payment fields
      togglePaymentFields();
      
      // Get current totals
      const cartDoc = await getDoc(doc(db, 'carts', currentUser.uid));
      const items = cartDoc.data().items || [];
      const subtotal = items.reduce((sum, item) => sum + (item.price * item.qty), 0);
      const discount = appliedVoucher ? appliedVoucher.discount : 0;
      
      // Calculate shipping fee
      let shippingFee = 0;
      const shippingFeeDisplay = document.getElementById('shippingFeeDisplay');
      
      if (paymentMethod === 'cod') {
        if (window.shippingSettings.freeShipping) {
          shippingFee = 0;
          shippingFeeDisplay.style.display = 'flex';
          document.getElementById('shippingFeeAmount').innerHTML = '<span style="color:green">FREE</span>';
        } else {
          shippingFee = window.shippingSettings.codFee || 50;
          shippingFeeDisplay.style.display = 'flex';
          document.getElementById('shippingFeeAmount').textContent = `‚Ç±${shippingFee.toFixed(2)}`;
        }
      } else {
        shippingFeeDisplay.style.display = 'none';
      }
      
      // Update total
      const total = subtotal - discount + shippingFee;
      document.getElementById('checkoutTotal').textContent = `‚Ç±${total.toFixed(2)}`;
    };

    window.togglePaymentFields = () => {
      const method = document.getElementById('paymentMethod').value;
      const container = document.getElementById('paymentFields');

      if (method === 'bank') {
        container.innerHTML = `
          <div class="input-group">
            <label>Bank Name</label>
            <input type="text" id="bankName" placeholder="BDO, BPI, etc.">
          </div>
          <div class="input-group">
            <label>Account Number</label>
            <input type="text" id="accountNumber" placeholder="1234567890">
          </div>
          <div class="input-group">
            <label>Account Name</label>
            <input type="text" id="accountName" placeholder="Juan Dela Cruz">
          </div>
        `;
      } else if (method === 'gcash') {
        container.innerHTML = `
          <div class="input-group">
            <label>GCash Number</label>
            <input type="tel" id="gcashNumber" placeholder="09123456789">
          </div>
          <div class="input-group">
            <label>Account Name</label>
            <input type="text" id="gcashName" placeholder="Juan Dela Cruz">
          </div>
        `;
      } else if (method === 'cod') {
        container.innerHTML = '<p style="color:var(--text-gray)">Pay when you receive your order</p>';
      } else {
        container.innerHTML = '';
      }
    };

    window.placeOrder = async () => {
      const billingName = document.getElementById('billingName').value;
      const billingAddress = document.getElementById('billingAddress').value;
      const billingPhone = document.getElementById('billingPhone').value;
      const paymentMethod = document.getElementById('paymentMethod').value;

      if (!billingName || !billingAddress || !billingPhone) {
        showToast('Please fill billing information', 'error');
        return;
      }

      if (!paymentMethod) {
        showToast('Please select a payment method', 'error');
        return;
      }

      // Check if user is suspended before placing order
      if (userProfile?.suspended) {
        await signOut(auth);
        showToast('Your account has been suspended. Please contact support.', 'error');
        showSection('auth');
        return;
      }

      let paymentInfo = { method: paymentMethod };

      if (paymentMethod === 'bank') {
        const bankName = document.getElementById('bankName').value;
        const accountNumber = document.getElementById('accountNumber').value;
        const accountName = document.getElementById('accountName').value;
        
        if (!bankName || !accountNumber || !accountName) {
          showToast('Please fill all bank details', 'error');
          return;
        }
        
        paymentInfo = { ...paymentInfo, bankName, accountNumber, accountName };
      } else if (paymentMethod === 'gcash') {
        const gcashNumber = document.getElementById('gcashNumber').value;
        const gcashName = document.getElementById('gcashName').value;
        
        if (!gcashNumber || !gcashName) {
          showToast('Please fill all GCash details', 'error');
          return;
        }
        
        paymentInfo = { ...paymentInfo, gcashNumber, gcashName };
      }

      try {
        const cartRef = doc(db, 'carts', currentUser.uid);
        const cartDoc = await getDoc(cartRef);
        const items = cartDoc.data().items || [];

        // Validate stock using transaction
        await runTransaction(db, async (transaction) => {
          // IMPORTANT: All reads must come first before any writes
          const stockChecks = [];
          
          // Read all products first
          for (const item of items) {
            const productRef = doc(db, 'products', item.productId);
            const productDoc = await transaction.get(productRef);
            
            if (!productDoc.exists()) {
              throw new Error(`Product ${item.name} not found`);
            }
            
            const product = productDoc.data();
            if (product.stock < item.qty) {
              throw new Error(`Not enough stock for ${item.name}`);
            }
            
            stockChecks.push({ ref: productRef, newStock: product.stock - item.qty });
          }

          // Read user data if voucher is applied (must be before writes)
          let userVouchersUsed = {};
          if (appliedVoucher) {
            const userRef = doc(db, 'users', currentUser.uid);
            const userDoc = await transaction.get(userRef);
            userVouchersUsed = userDoc.data().vouchersUsed || {};
          }

          // NOW START WRITES - all reads are complete
          
          // Create order
          const orderId = doc(collection(db, 'orders')).id;
          const orderRef = doc(db, 'orders', orderId);
          
          const subtotal = items.reduce((sum, item) => sum + (item.price * item.qty), 0);
          const discount = appliedVoucher ? appliedVoucher.discount : 0;
          
          // Calculate shipping fee
          let shippingFee = 0;
          if (paymentInfo.method === 'cod') {
            if (window.shippingSettings.freeShipping) {
              shippingFee = 0;
            } else {
              shippingFee = window.shippingSettings.codFee || 50;
            }
          }
          
          const total = subtotal - discount + shippingFee;
          
          transaction.set(orderRef, {
            uid: currentUser.uid,
            items: items.map(i => ({
              productId: i.productId,
              name: i.name,
              variant: i.variant,
              qty: i.qty,
              price: i.price
            })),
            subtotal,
            discount,
            shippingFee,
            voucherCode: appliedVoucher ? appliedVoucher.code : null,
            total,
            billingSnapshot: {
              name: billingName,
              address: billingAddress,
              phone: billingPhone
            },
            paymentMethod: paymentInfo.method,
            paymentInfo,
            status: 'pending',
            createdAt: serverTimestamp()
          });

          // Update stock
          for (const check of stockChecks) {
            transaction.update(check.ref, { stock: check.newStock });
          }

          // Update voucher usage if applied
          if (appliedVoucher) {
            const voucherRef = doc(db, 'vouchers', appliedVoucher.code);
            transaction.update(voucherRef, {
              usedCount: (appliedVoucher.usedCount || 0) + 1
            });

            // Update user's voucher usage (data already read above)
            const userRef = doc(db, 'users', currentUser.uid);
            userVouchersUsed[appliedVoucher.code] = (userVouchersUsed[appliedVoucher.code] || 0) + 1;
            transaction.update(userRef, { vouchersUsed: userVouchersUsed });
          }

          // Clear cart
          transaction.set(cartRef, { items: [], updatedAt: serverTimestamp() });
        });

        // Save billing info
        await updateDoc(doc(db, 'users', currentUser.uid), {
          billing: {
            name: billingName,
            address: billingAddress,
            phone: billingPhone
          }
        });

        // Clear applied voucher
        appliedVoucher = null;

        showToast('Order placed successfully!', 'success');
        updateCartBadge();
        showSection('orders');
      } catch (error) {
        showToast(error.message || 'Error placing order', 'error');
      }
    };

    window.loadOrders = async () => {
      const container = document.getElementById('ordersList');

      if (!currentUser) {
        container.innerHTML = '<div class="empty-state"><p>Please login to view orders</p></div>';
        return;
      }

      try {
        const q = query(
          collection(db, 'orders'),
          where('uid', '==', currentUser.uid),
          orderBy('createdAt', 'desc')
        );
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
          container.innerHTML = '<div class="empty-state"><p>No orders yet</p></div>';
          return;
        }

        container.innerHTML = '';
        snapshot.forEach(doc => {
          const order = { id: doc.id, ...doc.data() };
          const orderEl = document.createElement('div');
          orderEl.className = 'order-item';
          orderEl.innerHTML = `
            <div class="order-header">
              <div>
                <div style="font-weight:600">Order #${order.id.substring(0, 8)}</div>
                <div style="font-size:0.85rem;color:var(--text-gray)">
                  ${order.createdAt?.toDate().toLocaleDateString()}
                </div>
              </div>
              <span class="order-status ${order.status}">${order.status.toUpperCase()}</span>
            </div>
            ${order.items.map(item => `
              <div style="font-size:0.9rem;margin-bottom:0.25rem">
                ${item.name} ${item.variant ? `(${item.variant})` : ''} x${item.qty} - ‚Ç±${(item.price * item.qty).toFixed(2)}
              </div>
            `).join('')}
            <div style="border-top:1px solid var(--border);margin-top:0.5rem;padding-top:0.5rem;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.5rem">
              <div>
                <div style="font-weight:600;margin-bottom:0.25rem">Total: ‚Ç±${order.total.toFixed(2)}</div>
                <div style="font-size:0.85rem;color:var(--text-gray)">
                  Payment: ${order.paymentMethod.toUpperCase()}
                  ${order.shippingFee > 0 ? ` ‚Ä¢ Shipping: ‚Ç±${order.shippingFee.toFixed(2)}` : ''}
                  ${order.shippingFee === 0 && order.paymentMethod === 'cod' ? ' ‚Ä¢ Free Shipping' : ''}
                </div>
              </div>
            </div>
            ${order.cancelReason ? `
              <div style="background:var(--bg-light);padding:0.75rem;border-radius:6px;margin-top:0.5rem">
                <div style="font-weight:600;font-size:0.9rem;margin-bottom:0.25rem;color:var(--red)">Cancelled</div>
                <div style="font-size:0.85rem;color:var(--text-gray)">Reason: ${order.cancelReason}</div>
              </div>
            ` : ''}
            <div style="display:flex;gap:0.5rem;margin-top:0.5rem;flex-wrap:wrap">
              ${order.status === 'pending' && !order.cancelReason ? `
                <button class="btn btn-outline" style="flex:1" onclick="showCancelOrderModal('${order.id}')">
                  Cancel Order
                </button>
              ` : ''}
              ${order.items.some(item => !item.rated) && order.status === 'completed' ? `
                <button class="btn btn-outline" style="flex:1" onclick="showRatingModal('${order.items[0].productId}')">
                  Rate Product
                </button>
              ` : ''}
            </div>
          `;
          container.appendChild(orderEl);
        });
      } catch (error) {
        showToast('Error loading orders', 'error');
      }
    };

    window.showCancelOrderModal = (orderId) => {
      document.getElementById('cancelOrderId').value = orderId;
      document.getElementById('cancelReason').value = '';
      document.getElementById('otherReason').value = '';
      document.getElementById('otherReasonGroup').style.display = 'none';
      document.getElementById('cancelOrderModal').classList.add('active');
    };

    // Show/hide other reason textarea
    document.addEventListener('DOMContentLoaded', () => {
      const cancelReasonSelect = document.getElementById('cancelReason');
      if (cancelReasonSelect) {
        cancelReasonSelect.addEventListener('change', (e) => {
          const otherGroup = document.getElementById('otherReasonGroup');
          if (e.target.value === 'Other') {
            otherGroup.style.display = 'block';
          } else {
            otherGroup.style.display = 'none';
          }
        });
      }
    });

    window.confirmCancelOrder = async () => {
      const orderId = document.getElementById('cancelOrderId').value;
      let reason = document.getElementById('cancelReason').value;

      if (!reason) {
        showToast('Please select a reason', 'error');
        return;
      }

      if (reason === 'Other') {
        const otherReason = document.getElementById('otherReason').value;
        if (!otherReason) {
          showToast('Please specify the reason', 'error');
          return;
        }
        reason = otherReason;
      }

      try {
        // Update order status and add cancel reason
        await updateDoc(doc(db, 'orders', orderId), {
          status: 'cancelled',
          cancelReason: reason,
          cancelledAt: serverTimestamp()
        });

        showToast('Order cancelled successfully', 'success');
        closeModal('cancelOrderModal');
        loadOrders();
      } catch (error) {
        showToast('Error cancelling order', 'error');
      }
    };

    window.applyAsSeller = async () => {
      if (!currentUser) {
        showToast('Please login first', 'error');
        return;
      }

      const sellerName = document.getElementById('sellerName').value;
      const shopName = document.getElementById('shopName').value;
      const contactNumber = document.getElementById('contactNumber').value;
      const sellerEmail = document.getElementById('sellerEmail').value;

      if (!sellerName || !shopName || !contactNumber || !sellerEmail) {
        showToast('Please fill all fields', 'error');
        return;
      }

      try {
        await setDoc(doc(db, 'sellers', currentUser.uid), {
          sellerName,
          shopName,
          contactNumber,
          email: sellerEmail,
          status: 'pending',
          createdAt: serverTimestamp()
        });

        showToast('Application submitted! Waiting for approval', 'success');
        showSection('account');
      } catch (error) {
        showToast('Error submitting application', 'error');
      }
    };

    window.showAddProductModal = () => {
      document.getElementById('productFormTitle').textContent = 'Add Product';
      document.getElementById('editProductId').value = '';
      document.getElementById('productName').value = '';
      document.getElementById('productPrice').value = '';
      document.getElementById('productStock').value = '';
      document.getElementById('productDescription').value = '';
      document.getElementById('productVariants').value = '';
      document.getElementById('productCategory').value = '';
      productImages = ['', '', ''];
      updateImagePreviews();
      document.getElementById('addProductModal').classList.add('active');
    };

    window.triggerImageUpload = (index) => {
      document.getElementById(`imageUpload${index}`).click();
    };

    window.handleImageUpload = (index) => {
      const file = document.getElementById(`imageUpload${index}`).files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        productImages[index] = e.target.result;
        updateImagePreviews();
      };
      reader.readAsDataURL(file);
    };

    function updateImagePreviews() {
      for (let i = 0; i < 3; i++) {
        const container = document.getElementById('imagePreviewGrid').children[i];
        if (productImages[i]) {
          container.innerHTML = `
            <img src="${productImages[i]}" alt="Preview">
            <button class="image-preview-remove" onclick="removeImage(${i})">√ó</button>
          `;
        } else {
          container.innerHTML = `
            <span>+</span>
            <input type="file" id="imageUpload${i}" accept="image/*" style="display:none" onchange="handleImageUpload(${i})">
          `;
        }
      }
    }

    window.removeImage = (index) => {
      productImages[index] = '';
      updateImagePreviews();
    };

    window.saveProduct = async () => {
      if (!currentUser) return;

      const name = document.getElementById('productName').value;
      const price = parseFloat(document.getElementById('productPrice').value);
      const stock = parseInt(document.getElementById('productStock').value);
      const description = document.getElementById('productDescription').value;
      const variantsStr = document.getElementById('productVariants').value;
      const category = document.getElementById('productCategory').value;
      const variants = variantsStr ? variantsStr.split(',').map(v => v.trim()) : [];

      if (!name || !price || !stock || !description || !category) {
        showToast('Please fill all required fields', 'error');
        return;
      }

      const productData = {
        name,
        price,
        stock,
        description,
        category,
        variants,
        images: productImages.filter(img => img),
        sellerId: currentUser.uid,
        active: true,
        ratings: []
      };

      try {
        const editId = document.getElementById('editProductId').value;
        
        if (editId) {
          await updateDoc(doc(db, 'products', editId), {
            ...productData,
            updatedAt: serverTimestamp()
          });
          showToast('Product updated!', 'success');
        } else {
          await setDoc(doc(collection(db, 'products')), {
            ...productData,
            createdAt: serverTimestamp()
          });
          showToast('Product added!', 'success');
        }

        closeModal('addProductModal');
        loadSellerProducts();
      } catch (error) {
        showToast('Error saving product', 'error');
      }
    };

    window.loadSellerProducts = async () => {
      const container = document.getElementById('sellerProducts');
      container.innerHTML = '<div class="skeleton" style="height:300px"></div>'.repeat(3);

      try {
        const q = query(
          collection(db, 'products'),
          where('sellerId', '==', currentUser.uid)
        );
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
          container.innerHTML = '<div class="empty-state"><p>No products yet</p></div>';
          return;
        }

        container.innerHTML = '';
        snapshot.forEach(doc => {
          const product = { id: doc.id, ...doc.data() };
          const card = document.createElement('div');
          card.className = 'product-card';
          
          const avgRating = product.ratings?.length > 0 
            ? (product.ratings.reduce((a, b) => a + b.rating, 0) / product.ratings.length).toFixed(1)
            : 'No ratings';

          card.innerHTML = `
            <img src="${product.images?.[0] || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect fill="%23f0f0f0" width="200" height="200"/%3E%3C/svg%3E'}" 
                 alt="${product.name}" class="product-image">
            <div class="product-info">
              <div class="product-name">${product.name}</div>
              <div class="product-price">‚Ç±${parseFloat(product.price).toFixed(2)}</div>
              <div style="font-size:0.85rem;color:var(--text-gray);margin-bottom:0.5rem">
                Stock: ${product.stock} | ‚≠ê ${avgRating}
              </div>
              <div style="font-size:0.85rem;margin-bottom:0.5rem">
                Status: <span style="color:${product.active ? 'green' : 'red'}">${product.active ? 'Active' : 'Inactive'}</span>
              </div>
              <div class="product-actions">
                <button class="btn btn-outline" style="flex:1;padding:0.5rem" onclick="editProduct('${product.id}')">Edit</button>
                <button class="btn btn-outline" style="flex:1;padding:0.5rem" onclick="toggleProductActive('${product.id}', ${!product.active})">
                  ${product.active ? 'Deactivate' : 'Activate'}
                </button>
                <button class="btn btn-outline" style="padding:0.5rem" onclick="deleteProduct('${product.id}')">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                  </svg>
                </button>
              </div>
            </div>
          `;
          container.appendChild(card);
        });
      } catch (error) {
        showToast('Error loading products', 'error');
      }
    };

    window.editProduct = async (productId) => {
      try {
        const productDoc = await getDoc(doc(db, 'products', productId));
        const product = productDoc.data();

        document.getElementById('productFormTitle').textContent = 'Edit Product';
        document.getElementById('editProductId').value = productId;
        document.getElementById('productName').value = product.name;
        document.getElementById('productPrice').value = product.price;
        document.getElementById('productStock').value = product.stock;
        document.getElementById('productDescription').value = product.description;
        document.getElementById('productVariants').value = product.variants?.join(', ') || '';
        document.getElementById('productCategory').value = product.category || '';
        
        productImages = [...(product.images || []), '', '', ''].slice(0, 3);
        updateImagePreviews();
        
        document.getElementById('addProductModal').classList.add('active');
      } catch (error) {
        showToast('Error loading product', 'error');
      }
    };

    window.toggleProductActive = async (productId, active) => {
      try {
        await updateDoc(doc(db, 'products', productId), { active });
        showToast(`Product ${active ? 'activated' : 'deactivated'}`, 'success');
        loadSellerProducts();
      } catch (error) {
        showToast('Error updating product', 'error');
      }
    };

    window.deleteProduct = async (productId) => {
      if (!confirm('Are you sure you want to delete this product?')) return;

      try {
        await deleteDoc(doc(db, 'products', productId));
        showToast('Product deleted', 'success');
        loadSellerProducts();
      } catch (error) {
        showToast('Error deleting product', 'error');
      }
    };

    window.loadAccount = async () => {
      const container = document.getElementById('accountContent');

      if (!currentUser) {
        container.innerHTML = `
          <div class="empty-state">
            <p>Please login to view your account</p>
            <button class="btn btn-primary" onclick="showSection('auth')">Login</button>
          </div>
        `;
        return;
      }

      try {
        const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
        const userData = userDoc.data();
        const sellerDoc = await getDoc(doc(db, 'sellers', currentUser.uid));
        const sellerData = sellerDoc.exists() ? sellerDoc.data() : null;

        container.innerHTML = `
          <div style="display:grid;gap:1rem">
            ${userData.profilePicture ? `
              <div style="text-align:center">
                <img src="${userData.profilePicture}" alt="Profile" style="width:100px;height:100px;border-radius:50%;object-fit:cover;border:3px solid var(--border)">
              </div>
            ` : ''}
            <div>
              <div style="font-weight:600;margin-bottom:0.5rem">Email</div>
              <div>${userData.email}</div>
            </div>
            <div>
              <div style="font-weight:600;margin-bottom:0.5rem">Username</div>
              <div>${userData.username}</div>
            </div>
            <div>
              <div style="font-weight:600;margin-bottom:0.5rem">Role</div>
              <div style="text-transform:capitalize">${userData.role}</div>
            </div>
            <div>
              <div style="font-weight:600;margin-bottom:0.5rem">Coins Balance</div>
              <div style="color:var(--gold);font-size:1.5rem;font-weight:700">${userData.coins || 0}</div>
              <button class="btn btn-secondary" style="margin-top:0.5rem" onclick="claimDailyCoins()">Claim Daily Coins</button>
            </div>
            
            ${sellerData ? `
              <div style="border-top:1px solid var(--border);padding-top:1rem">
                <div style="font-weight:600;margin-bottom:0.5rem">Seller Status</div>
                <div style="text-transform:capitalize;color:${
                  sellerData.status === 'approved' ? 'green' : 
                  sellerData.status === 'pending' ? 'orange' : 'red'
                }">${sellerData.status}</div>
                ${sellerData.status === 'approved' ? `
                  <button class="btn btn-primary" style="margin-top:0.5rem" onclick="showSection('sellerDashboard')">
                    Go to Seller Dashboard
                  </button>
                ` : ''}
              </div>
            ` : `
              <button class="btn btn-primary" onclick="showSection('sellerApplication')">Apply as Seller</button>
            `}

            <div style="border-top:1px solid var(--border);padding-top:1rem">
              <button class="btn btn-outline" style="width:100%;margin-bottom:0.5rem" onclick="showSection('orders')">My Orders</button>
              <button class="btn btn-outline" style="width:100%;margin-bottom:0.5rem" onclick="showSection('settings')">Settings</button>
              ${userData.role === 'admin' ? `
                <button class="btn btn-secondary" style="width:100%;margin-bottom:0.5rem" onclick="showSection('adminPanel')">Admin Panel</button>
              ` : ''}
              <button class="btn btn-outline" style="width:100%" onclick="logout()">Logout</button>
            </div>
          </div>
        `;
      } catch (error) {
        showToast('Error loading account', 'error');
      }
    };

    // Settings Functions
    window.loadSettings = async () => {
      if (!currentUser) {
        showToast('Please login first', 'error');
        showSection('auth');
        return;
      }

      try {
        const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
        const userData = userDoc.data();

        // Load profile picture
        const profilePicContainer = document.getElementById('profilePicContainer');
        if (userData.profilePicture) {
          profilePicContainer.innerHTML = `
            <img src="${userData.profilePicture}" class="profile-pic-preview" onclick="document.getElementById('profilePicUpload').click()">
            <div><button class="btn btn-outline" onclick="removeProfilePic()">Remove Picture</button></div>
          `;
        } else {
          profilePicContainer.innerHTML = `
            <div class="profile-pic-placeholder" onclick="document.getElementById('profilePicUpload').click()">+</div>
            <div style="color:var(--text-gray);font-size:0.9rem">Click to upload profile picture</div>
          `;
        }

        // Load billing info
        if (userData.billing) {
          document.getElementById('settingsBillingName').value = userData.billing.name || '';
          document.getElementById('settingsBillingAddress').value = userData.billing.address || '';
          document.getElementById('settingsBillingPhone').value = userData.billing.phone || '';
        }

        // Highlight current theme
        const theme = localStorage.getItem('theme') || 'light';
        updateThemeButtons(theme);
      } catch (error) {
        showToast('Error loading settings', 'error');
      }
    };

    window.handleProfilePicUpload = () => {
      const file = document.getElementById('profilePicUpload').files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          await updateDoc(doc(db, 'users', currentUser.uid), {
            profilePicture: e.target.result
          });
          showToast('Profile picture updated!', 'success');
          loadSettings();
          loadAccount();
        } catch (error) {
          showToast('Error updating profile picture', 'error');
        }
      };
      reader.readAsDataURL(file);
    };

    window.removeProfilePic = async () => {
      try {
        await updateDoc(doc(db, 'users', currentUser.uid), {
          profilePicture: ''
        });
        showToast('Profile picture removed', 'success');
        loadSettings();
        loadAccount();
      } catch (error) {
        showToast('Error removing profile picture', 'error');
      }
    };

    window.updateUsername = async () => {
      const newUsername = document.getElementById('newUsername').value;
      
      if (!newUsername) {
        showToast('Please enter a username', 'error');
        return;
      }

      try {
        await updateProfile(currentUser, { displayName: newUsername });
        await updateDoc(doc(db, 'users', currentUser.uid), {
          username: newUsername
        });
        showToast('Username updated!', 'success');
        document.getElementById('newUsername').value = '';
        loadAccount();
      } catch (error) {
        showToast('Error updating username', 'error');
      }
    };

    window.updatePasswordUser = async () => {
      const currentPass = document.getElementById('currentPassword').value;
      const newPass = document.getElementById('newPassword').value;
      const confirmPass = document.getElementById('confirmPassword').value;

      if (!currentPass || !newPass || !confirmPass) {
        showToast('Please fill all password fields', 'error');
        return;
      }

      if (newPass !== confirmPass) {
        showToast('Passwords do not match', 'error');
        return;
      }

      if (newPass.length < 6) {
        showToast('Password must be at least 6 characters', 'error');
        return;
      }

      try {
        // Reauthenticate user
        const credential = EmailAuthProvider.credential(currentUser.email, currentPass);
        await reauthenticateWithCredential(currentUser, credential);
        
        // Update password
        await updatePassword(currentUser, newPass);
        
        showToast('Password updated successfully!', 'success');
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
      } catch (error) {
        if (error.code === 'auth/wrong-password') {
          showToast('Current password is incorrect', 'error');
        } else {
          showToast('Error updating password', 'error');
        }
      }
    };

    window.setTheme = (theme) => {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      updateThemeButtons(theme);
      showToast(`${theme === 'dark' ? 'Dark' : 'Light'} mode activated`, 'success');
    };

    function updateThemeButtons(theme) {
      const lightBtn = document.getElementById('lightThemeBtn');
      const darkBtn = document.getElementById('darkThemeBtn');
      
      if (theme === 'dark') {
        darkBtn?.classList.add('btn-primary');
        darkBtn?.classList.remove('btn-outline');
        lightBtn?.classList.add('btn-outline');
        lightBtn?.classList.remove('btn-primary');
      } else {
        lightBtn?.classList.add('btn-primary');
        lightBtn?.classList.remove('btn-outline');
        darkBtn?.classList.add('btn-outline');
        darkBtn?.classList.remove('btn-primary');
      }
    }

    window.updateBillingInfo = async () => {
      const name = document.getElementById('settingsBillingName').value;
      const address = document.getElementById('settingsBillingAddress').value;
      const phone = document.getElementById('settingsBillingPhone').value;

      if (!name || !address || !phone) {
        showToast('Please fill all billing fields', 'error');
        return;
      }

      try {
        await updateDoc(doc(db, 'users', currentUser.uid), {
          billing: { name, address, phone }
        });
        showToast('Billing info updated!', 'success');
      } catch (error) {
        showToast('Error updating billing info', 'error');
      }
    };

    window.claimDailyCoins = async () => {
      try {
        const userRef = doc(db, 'users', currentUser.uid);
        const userDoc = await getDoc(userRef);
        const userData = userDoc.data();

        const lastClaim = userData.lastDailyClaim?.toDate();
        const now = new Date();
        
        if (lastClaim && now - lastClaim < 24 * 60 * 60 * 1000) {
          const hoursLeft = Math.ceil((24 * 60 * 60 * 1000 - (now - lastClaim)) / (60 * 60 * 1000));
          showToast(`Please wait ${hoursLeft} hours before claiming again`, 'error');
          return;
        }

        await updateDoc(userRef, {
          coins: (userData.coins || 0) + 10,
          lastDailyClaim: serverTimestamp()
        });

        showToast('Claimed 10 coins!', 'success');
        loadAccount();
      } catch (error) {
        showToast('Error claiming coins', 'error');
      }
    };

    window.loadAdminPanel = async () => {
      const container = document.getElementById('adminContent');

      try {
        const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
        if (userDoc.data().role !== 'admin') {
          container.innerHTML = '<div class="empty-state"><p>Access denied</p></div>';
          return;
        }

        showAdminTab(currentAdminTab);
      } catch (error) {
        showToast('Error loading admin panel', 'error');
      }
    };

    window.showAdminTab = async (tab) => {
      currentAdminTab = tab;
      const container = document.getElementById('adminContent');

      // Update button styles
      document.querySelectorAll('#adminPanel .btn').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline');
      });
      event?.target?.classList.remove('btn-outline');
      event?.target?.classList.add('btn-primary');

      if (tab === 'sellers') {
        await loadPendingSellers(container);
      } else if (tab === 'users') {
        await loadAllUsers(container);
      } else if (tab === 'vouchers') {
        await loadVouchers(container);
      }
    };

    async function loadPendingSellers(container) {
      const sellersSnapshot = await getDocs(
        query(collection(db, 'sellers'), where('status', '==', 'pending'))
      );

      container.innerHTML = `
        <div>
          <h4 style="margin-bottom:1rem">Pending Seller Applications</h4>
          ${sellersSnapshot.empty ? '<p>No pending applications</p>' : ''}
          <div style="display:grid;gap:1rem">
            ${sellersSnapshot.docs.map(doc => {
              const seller = { id: doc.id, ...doc.data() };
              return `
                <div class="card">
                  <div style="font-weight:600;margin-bottom:0.5rem">${seller.shopName}</div>
                  <div style="font-size:0.9rem;color:var(--text-gray);margin-bottom:0.5rem">
                    Seller: ${seller.sellerName}<br>
                    Email: ${seller.email}<br>
                    Contact: ${seller.contactNumber}
                  </div>
                  <div style="display:flex;gap:0.5rem">
                    <button class="btn btn-primary" style="flex:1" onclick="approveRejectSeller('${seller.id}', 'approved')">
                      Approve
                    </button>
                    <button class="btn btn-outline" style="flex:1" onclick="approveRejectSeller('${seller.id}', 'rejected')">
                      Reject
                    </button>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    async function loadAllUsers(container) {
      const usersSnapshot = await getDocs(collection(db, 'users'));

      container.innerHTML = `
        <div>
          <h4 style="margin-bottom:1rem">All Registered Users</h4>
          <div style="overflow-x:auto">
            <table style="width:100%;border-collapse:collapse">
              <thead>
                <tr style="border-bottom:2px solid var(--border);text-align:left">
                  <th style="padding:0.75rem">Username</th>
                  <th style="padding:0.75rem">Email</th>
                  <th style="padding:0.75rem">Role</th>
                  <th style="padding:0.75rem">Status</th>
                  <th style="padding:0.75rem">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${usersSnapshot.docs.map(doc => {
                  const user = { id: doc.id, ...doc.data() };
                  return `
                    <tr style="border-bottom:1px solid var(--border)">
                      <td style="padding:0.75rem">${user.username || 'N/A'}</td>
                      <td style="padding:0.75rem">${user.email}</td>
                      <td style="padding:0.75rem">
                        <span style="text-transform:capitalize;color:${user.role === 'admin' ? 'var(--red)' : user.role === 'seller' ? 'var(--blue)' : 'var(--text-gray)'}">${user.role}</span>
                      </td>
                      <td style="padding:0.75rem">
                        <span style="color:${user.suspended ? 'var(--red)' : 'green'}">${user.suspended ? 'Suspended' : 'Active'}</span>
                      </td>
                      <td style="padding:0.75rem">
                        ${user.role !== 'admin' ? `
                          <button class="btn btn-outline" style="padding:0.5rem 1rem;font-size:0.85rem" 
                            onclick="toggleUserSuspension('${user.id}', ${!user.suspended})">
                            ${user.suspended ? 'Unsuspend' : 'Suspend'}
                          </button>
                        ` : '<span style="color:var(--text-gray)">-</span>'}
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    async function loadVouchers(container) {
      const vouchersSnapshot = await getDocs(collection(db, 'vouchers'));
      
      // Get shipping settings
      const settingsDoc = await getDoc(doc(db, 'settings', 'shipping'));
      const shippingSettings = settingsDoc.exists() ? settingsDoc.data() : { freeShipping: false, codFee: 50 };

      container.innerHTML = `
        <div>
          <!-- Shipping Settings Section -->
          <div style="background:var(--bg-light);padding:1.5rem;border-radius:8px;margin-bottom:2rem">
            <h4 style="margin-bottom:1rem">Shipping Settings</h4>
            <div style="display:grid;gap:1rem">
              <div style="display:flex;align-items:center;justify-content:space-between">
                <div>
                  <div style="font-weight:600;margin-bottom:0.25rem">Free Shipping</div>
                  <div style="font-size:0.85rem;color:var(--text-gray)">Enable free shipping for all Cash on Delivery orders</div>
                </div>
                <label style="position:relative;display:inline-block;width:60px;height:30px">
                  <input type="checkbox" id="freeShippingToggle" ${shippingSettings.freeShipping ? 'checked' : ''} onchange="toggleFreeShipping()" style="opacity:0;width:0;height:0">
                  <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:${shippingSettings.freeShipping ? 'var(--blue)' : '#ccc'};border-radius:30px;transition:0.4s"></span>
                  <span style="position:absolute;content:'';height:22px;width:22px;left:4px;bottom:4px;background:white;border-radius:50%;transition:0.4s;transform:${shippingSettings.freeShipping ? 'translateX(30px)' : 'translateX(0)'}"></span>
                </label>
              </div>
              <div style="display:${shippingSettings.freeShipping ? 'none' : 'block'}">
                <label style="font-weight:600;display:block;margin-bottom:0.5rem">COD Shipping Fee (‚Ç±)</label>
                <div style="display:flex;gap:0.5rem">
                  <input type="number" id="codFeeInput" value="${shippingSettings.codFee || 50}" step="0.01" style="flex:1;padding:0.5rem;border:1px solid var(--border);border-radius:6px">
                  <button class="btn btn-primary" onclick="updateShippingFee()">Update</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Vouchers Section -->
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
            <h4>Vouchers</h4>
            <button class="btn btn-primary" onclick="showCreateVoucherModal()">Create Voucher</button>
          </div>
          ${vouchersSnapshot.empty ? '<p>No vouchers created yet</p>' : ''}
          <div style="display:grid;gap:1rem">
            ${vouchersSnapshot.docs.map(doc => {
              const voucher = { id: doc.id, ...doc.data() };
              const isExpired = voucher.expiresAt && new Date(voucher.expiresAt) < new Date();
              return `
                <div class="card">
                  <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:0.5rem">
                    <div>
                      <div style="font-weight:700;font-size:1.25rem;color:var(--red)">${voucher.code}</div>
                      <div style="font-size:0.9rem;color:var(--text-gray)">
                        ${voucher.type === 'percentage' ? `${voucher.amount}% OFF` : `‚Ç±${voucher.amount} OFF`}
                      </div>
                    </div>
                    <span style="padding:0.25rem 0.75rem;border-radius:12px;font-size:0.85rem;background:${voucher.active && !isExpired ? '#D1FAE5' : '#FEE2E2'};color:${voucher.active && !isExpired ? '#065F46' : '#991B1B'}">
                      ${isExpired ? 'Expired' : voucher.active ? 'Active' : 'Inactive'}
                    </span>
                  </div>
                  <div style="font-size:0.85rem;color:var(--text-gray);margin-bottom:0.5rem">
                    Min Spend: ‚Ç±${voucher.minSpend || 0}<br>
                    Used: ${voucher.usedCount || 0}${voucher.usageLimit ? ` / ${voucher.usageLimit}` : ''}<br>
                    Per User: ${voucher.perUserLimit || 'Unlimited'}<br>
                    Expires: ${voucher.expiresAt ? new Date(voucher.expiresAt).toLocaleDateString() : 'No expiry'}
                  </div>
                  <div style="display:flex;gap:0.5rem">
                    <button class="btn btn-outline" style="flex:1" onclick="toggleVoucherStatus('${voucher.id}', ${!voucher.active})">
                      ${voucher.active ? 'Deactivate' : 'Activate'}
                    </button>
                    <button class="btn btn-outline" onclick="deleteVoucher('${voucher.id}')">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                      </svg>
                    </button>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    window.toggleFreeShipping = async () => {
      const isEnabled = document.getElementById('freeShippingToggle').checked;
      
      try {
        await setDoc(doc(db, 'settings', 'shipping'), {
          freeShipping: isEnabled,
          codFee: isEnabled ? 0 : (parseFloat(document.getElementById('codFeeInput')?.value) || 50),
          updatedAt: serverTimestamp()
        }, { merge: true });

        showToast(`Free shipping ${isEnabled ? 'enabled' : 'disabled'}`, 'success');
        loadAdminPanel();
      } catch (error) {
        showToast('Error updating shipping settings', 'error');
      }
    };

    window.updateShippingFee = async () => {
      const fee = parseFloat(document.getElementById('codFeeInput').value);
      
      if (isNaN(fee) || fee < 0) {
        showToast('Please enter a valid fee amount', 'error');
        return;
      }

      try {
        await setDoc(doc(db, 'settings', 'shipping'), {
          freeShipping: false,
          codFee: fee,
          updatedAt: serverTimestamp()
        }, { merge: true });

        showToast('Shipping fee updated', 'success');
        loadAdminPanel();
      } catch (error) {
        showToast('Error updating shipping fee', 'error');
      }
    };

    window.toggleUserSuspension = async (userId, suspend) => {
      if (!confirm(`Are you sure you want to ${suspend ? 'suspend' : 'unsuspend'} this user?`)) return;

      try {
        await updateDoc(doc(db, 'users', userId), {
          suspended: suspend,
          suspendedAt: suspend ? serverTimestamp() : null
        });

        showToast(`User ${suspend ? 'suspended' : 'unsuspended'} successfully`, 'success');
        
        // If suspending, check if user is currently logged in and force logout
        if (suspend) {
          showToast('User will be logged out on their next action', 'info');
        }
        
        loadAdminPanel();
      } catch (error) {
        showToast('Error updating user status', 'error');
      }
    };

    window.showCreateVoucherModal = () => {
      document.getElementById('voucherCode').value = '';
      document.getElementById('voucherType').value = 'percentage';
      document.getElementById('voucherAmount').value = '';
      document.getElementById('voucherMinSpend').value = '0';
      document.getElementById('voucherUsageLimit').value = '0';
      document.getElementById('voucherPerUserLimit').value = '1';
      document.getElementById('voucherExpiry').value = '';
      document.getElementById('createVoucherModal').classList.add('active');
    };

    window.createVoucher = async () => {
      const code = document.getElementById('voucherCode').value.trim().toUpperCase();
      const type = document.getElementById('voucherType').value;
      const amount = parseFloat(document.getElementById('voucherAmount').value);
      const minSpend = parseFloat(document.getElementById('voucherMinSpend').value);
      const usageLimit = parseInt(document.getElementById('voucherUsageLimit').value);
      const perUserLimit = parseInt(document.getElementById('voucherPerUserLimit').value);
      const expiry = document.getElementById('voucherExpiry').value;

      if (!code || !type || !amount || isNaN(amount)) {
        showToast('Please fill required fields (code, type, and amount)', 'error');
        return;
      }

      if (type === 'percentage' && (amount <= 0 || amount > 100)) {
        showToast('Percentage must be between 1 and 100', 'error');
        return;
      }

      if (type === 'fixed' && amount <= 0) {
        showToast('Fixed amount must be greater than 0', 'error');
        return;
      }

      try {
        // Check if code already exists
        const existingVoucher = await getDoc(doc(db, 'vouchers', code));
        if (existingVoucher.exists()) {
          showToast('Voucher code already exists', 'error');
          return;
        }

        await setDoc(doc(db, 'vouchers', code), {
          code,
          type,
          amount,
          minSpend: isNaN(minSpend) ? 0 : minSpend,
          usageLimit: isNaN(usageLimit) ? 0 : usageLimit,
          perUserLimit: isNaN(perUserLimit) ? 0 : perUserLimit,
          expiresAt: expiry || null,
          active: true,
          usedCount: 0,
          createdAt: serverTimestamp()
        });

        showToast('Voucher created successfully!', 'success');
        closeModal('createVoucherModal');
        loadAdminPanel();
      } catch (error) {
        console.error('Voucher creation error:', error);
        showToast('Error creating voucher: ' + error.message, 'error');
      }
    };

    window.toggleVoucherStatus = async (voucherId, active) => {
      try {
        await updateDoc(doc(db, 'vouchers', voucherId), { active });
        showToast(`Voucher ${active ? 'activated' : 'deactivated'}`, 'success');
        loadAdminPanel();
      } catch (error) {
        showToast('Error updating voucher', 'error');
      }
    };

    window.deleteVoucher = async (voucherId) => {
      if (!confirm('Are you sure you want to delete this voucher?')) return;

      try {
        await deleteDoc(doc(db, 'vouchers', voucherId));
        showToast('Voucher deleted', 'success');
        loadAdminPanel();
      } catch (error) {
        showToast('Error deleting voucher', 'error');
      }
    };

    window.approveRejectSeller = async (sellerId, status) => {
      try {
        await updateDoc(doc(db, 'sellers', sellerId), { status });
        
        if (status === 'approved') {
          await updateDoc(doc(db, 'users', sellerId), { role: 'seller' });
        }

        showToast(`Seller ${status}`, 'success');
        loadAdminPanel();
      } catch (error) {
        showToast('Error updating seller status', 'error');
      }
    };

    window.showRatingModal = (productId) => {
      document.getElementById('ratingProductId').value = productId;
      currentRating = 0;
      document.getElementById('ratingComment').value = '';
      
      const starsContainer = document.getElementById('ratingStars');
      starsContainer.innerHTML = '';
      for (let i = 1; i <= 5; i++) {
        const star = document.createElement('span');
        star.className = 'star';
        star.textContent = '‚òÖ';
        star.onclick = () => setRating(i);
        starsContainer.appendChild(star);
      }
      
      document.getElementById('ratingModal').classList.add('active');
    };

    window.setRating = (rating) => {
      currentRating = rating;
      const stars = document.querySelectorAll('#ratingStars .star');
      stars.forEach((star, index) => {
        if (index < rating) {
          star.classList.add('filled');
        } else {
          star.classList.remove('filled');
        }
      });
    };

    window.submitRating = async () => {
      if (currentRating === 0) {
        showToast('Please select a rating', 'error');
        return;
      }

      const productId = document.getElementById('ratingProductId').value;
      const comment = document.getElementById('ratingComment').value;

      try {
        const productRef = doc(db, 'products', productId);
        await updateDoc(productRef, {
          ratings: arrayUnion({
            uid: currentUser.uid,
            username: userProfile.username,
            rating: currentRating,
            comment,
            createdAt: serverTimestamp()
          })
        });

        showToast('Rating submitted!', 'success');
        closeModal('ratingModal');
      } catch (error) {
        showToast('Error submitting rating', 'error');
      }
    };

    // Auth State Observer
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      
      if (user) {
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        userProfile = userDoc.data();
        
        // Check if user is suspended
        if (userProfile?.suspended) {
          await signOut(auth);
          showToast('Your account has been suspended. Please contact support.', 'error');
          showSection('auth');
          return;
        }
        
        updateCartBadge();
      } else {
        userProfile = null;
      }
    });

    // Initialize theme
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);

    // Initialize
    loadProducts();
  </script>

  <!-- Firestore Security Rules Reference (implement in Firebase Console)
  
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      
      match /users/{userId} {
        allow read: if request.auth != null;
        allow write: if request.auth.uid == userId;
        allow update: if request.auth != null && 
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      match /sellers/{sellerId} {
        allow read: if request.auth != null;
        allow write: if request.auth.uid == sellerId;
      }
      
      match /products/{productId} {
        allow read: if true;
        allow create: if request.auth != null && 
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['seller', 'admin'];
        allow update, delete: if request.auth != null && 
          (resource.data.sellerId == request.auth.uid || 
           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
      }
      
      match /carts/{cartId} {
        allow read, write: if request.auth.uid == cartId;
      }
      
      match /orders/{orderId} {
        allow read: if request.auth != null && 
          (resource.data.uid == request.auth.uid || 
           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
        allow create: if request.auth != null && request.resource.data.uid == request.auth.uid;
        allow update: if request.auth != null && 
          (resource.data.uid == request.auth.uid || 
           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
      }
      
      match /vouchers/{voucherId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && 
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
    }
  }
  
  Firestore Data Model:
  
  users/{uid}:
    - email, username, role (user|seller|admin)
    - profilePicture (base64)
    - coins, lastDailyClaim
    - billing: {name, address, phone}
    - suspended: boolean
    - vouchersUsed: {voucherCode: usageCount}
  
  sellers/{uid}:
    - sellerName, shopName, contactNumber, email
    - status: pending|approved|rejected
  
  products/{productId}:
    - sellerId, name, description, price, stock
    - category, variants, images (base64 array)
    - active, ratings: [{uid, username, rating, comment, createdAt}]
  
  orders/{orderId}:
    - uid, items, subtotal, discount, voucherCode, shippingFee, total
    - billingSnapshot, paymentMethod, paymentInfo
    - status: pending|completed|cancelled
    - cancelReason, cancelledAt
  
  vouchers/{code}:
    - type: percentage|fixed
    - amount, minSpend
    - active, expiresAt
    - usageLimit, perUserLimit, usedCount
  
  settings/shipping:
    - freeShipping: boolean
    - codFee: number
    - updatedAt
  
  -->
</body>
</html>
